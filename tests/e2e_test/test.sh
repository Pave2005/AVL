#!/bin/bash

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–µ–¥–∞–Ω—ã –ª–∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã (1 ‚Äî –ø—É—Ç—å –∫ –±–∏–Ω–∞—Ä–Ω–∏–∫—É, 2 ‚Äî –ø—É—Ç—å –∫ —Ç–µ—Å—Ç–∞–º)
if [ $# -lt 2 ]; then
    echo "‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <–ø—É—Ç—å_–∫_–±–∏–Ω–∞—Ä–Ω–∏–∫—É> <–ø—É—Ç—å_–∫_–ø–∞–ø–∫–µ_—Å_—Ç–µ—Å—Ç–∞–º–∏>"
    exit 1
fi

binary="$1"        # –ü—É—Ç—å –∫ –±–∏–Ω–∞—Ä–Ω–∏–∫—É
data_dir="$2"      # –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å —Ç–µ—Å—Ç–∞–º–∏

if [ ! -d "$data_dir" ]; then
    echo "‚ùå –ü–∞–ø–∫–∞ $data_dir –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
    exit 1
fi

files=("$data_dir"/*.dat)

if [ ${#files[@]} -eq 0 ] || [ "${files[0]}" == "$data_dir/*.dat" ]; then
    echo "‚ùå –ù–µ—Ç —Ñ–∞–π–ª–æ–≤ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .dat –≤ –ø–∞–ø–∫–µ $data_dir."
    exit 1
fi

for file in "${files[@]}"; do
    base_name=$(basename "$file" .dat)        # –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
    expected_file="$data_dir/$base_name.ans"  # –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É .ans

    echo "üìÇ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞: $file"

    if [ ! -f "$expected_file" ]; then
        echo "‚ùå –§–∞–π–ª —Å –æ–∂–∏–¥–∞–µ–º—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º ($expected_file) –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        exit 1
    fi

    result=$("$binary" < "$file")     # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç

    read size < "$expected_file"
    expected_arr=($(awk 'NR>1 {print $0}' "$expected_file"))

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤—ã–≤–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–º—ã –≤ –º–∞—Å—Å–∏–≤
    result_arr=($result)

    # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤ –º–∞—Å—Å–∏–≤–æ–≤
    if [ ${#expected_arr[@]} -ne $size ] || [ ${#result_arr[@]} -ne $size ]; then
        echo "‚ùå –†–∞–∑–º–µ—Ä—ã –º–∞—Å—Å–∏–≤–æ–≤ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç! –†–∞–∑–º–µ—Ä –≤ expected: $size, –≤ –≤—ã–≤–æ–¥–µ: ${#result_arr[@]}"
        exit 1
    fi

    # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –º–∞—Å—Å–∏–≤–æ–≤
    for ((i = 0; i < $size; i++)); do
        if [ "${expected_arr[$i]}" -ne "${result_arr[$i]}" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç–µ $i! –û–∂–∏–¥–∞–ª–æ—Å—å: ${expected_arr[$i]}, –ø–æ–ª—É—á–µ–Ω–æ: ${result_arr[$i]}"
            exit 1
        fi
    done

    # –ï—Å–ª–∏ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–æ–≤–ø–∞–ª–∏
    echo "‚úÖ –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω!"
    echo "-----------------------------------"

done
